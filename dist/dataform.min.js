!function(a,b,c){"undefined"!=typeof module&&module.exports?module.exports=c():"function"==typeof define&&define.amd?define(c):b[a]=c()}("Dataform",this,function(){"use strict";function a(a,b){this.configure(a,b)}function b(a){var b=this,c=[],d=[],g=function(){var c,d;return""==a.collection?c=b.raw:(d=e.apply(b,[b.raw].concat(a.collection.split(" -> "))),c=d[0]),"[object Array]"!==Object.prototype.toString.call(c)&&(c=[c]),c}();return h(a.select,function(a){c.push(a.path.split(" -> "))}),0==c.length&&h(g,function(a){var b=f(a);for(var e in b)b.hasOwnProperty(e)&&-1==d.indexOf(e)&&(d.push(e),c.push([e]))}),h(g,function(a,d){var e=f(a);b.table.push([]),h(c,function(a){var c=a.join(".");0==d&&b.table[0].push(c),b.table[d+1].push(e[c])})}),b.format(a.select),b.sort(a.sort),b}function c(a){var b=this,c=[],d=a.unpack.value?a.unpack.value.path.split(" -> "):!1,f=a.unpack.label?a.unpack.label.path.split(" -> "):!1,g=a.unpack.index?a.unpack.index.path.split(" -> "):!1,i=""!==d[d.length-1]?d[d.length-1]:"Value",j=""!==f[f.length-1]?f[f.length-1]:"Label",k=""!==g[g.length-1]?g[g.length-1]:"Index",l=(a.sort&&a.sort.index?a.sort.index:!1,a.sort&&a.sort.value?a.sort.value:!1,function(){var c;return c=""==a.collection?[b.raw]:e.apply(b,[b.raw].concat(a.collection.split(" -> "))),c[0]}());return l instanceof Array==0&&(l=[l]),h(l,function(a){var d=f?e.apply(b,[a].concat(f)):[];d&&(c=d)}),h(l,function(a,f){var m=d?e.apply(b,[a].concat(d)):!1,n=g?e.apply(b,[a].concat(g)):!1;n?h(n,function(){b.table.push([])}):b.table.push([]),n&&(0==f&&(b.table[0].push(k),c.length>0?h(c,function(a){b.table[0].push(a)}):b.table[0].push(i)),l.length<b.table.length-1?0==f&&h(b.table,function(a,c){c>0&&b.table[c].push(n[c-1])}):b.table[f+1].push(n[0])),!n&&c.length>0&&(0==f&&(b.table[0].push(j),b.table[0].push(i)),b.table[f+1].push(c[0])),n||0!=c.length||b.table[0].push(""),m?l.length<b.table.length-1?0==f&&h(b.table,function(a,c){c>0&&b.table[c].push(m[c-1])}):h(m,function(a){b.table[f+1].push(a)}):h(b.table[0],function(a,c){var d=n?0:-1;c>d&&b.table[f+1].push(null)})}),b.format(a.unpack),b.sort(a.sort),this}function d(a){return h(a.unpack,function(b,c){b&&g(b,"string")&&(a.unpack[c]={path:a.unpack[c]})}),a}function e(){var a=[],b=function(){var c=arguments[0],d=Array.prototype.slice.call(arguments,1),e=d.pop();return 0===d.length&&(c instanceof Array?d=c:"object"==typeof c&&d.push(c)),h(d,function(f){if(""==e&&("number"==typeof f||null==f))return a.push(f);if(f[e]||0===f[e]||void 0!==f[e])return a.push(null===f[e]?"":f[e]);if(!c[f]){if("object"!=typeof c||c instanceof Array!=!1||c[e])return b.apply(this,[f].concat(d.splice(1)).concat(e));throw new Error("Target property does not exist",e)}return c[f]instanceof Array?void h(c[f],function(a,g){var h=[c[f]].concat(c[f][g]).concat(d.slice(1)).concat(e);return b.apply(this,h)}):c[f][e]?a.push(c[f][e]):b.apply(this,[c[f]].concat(d.splice(1)).concat(e))}),a.length>0?a:void 0};return b.apply(this,arguments)}function f(a){var b={};for(var c in a)if(a.hasOwnProperty(c))if("object"==typeof a[c]&&null!==a[c]){var d=f(a[c]);for(var e in d)d.hasOwnProperty(e)&&(b[c+"."+e]=d[e])}else b[c]=a[c];return b}function g(a,b){return a=typeof a,b?a==b:"undefined"!=a}function h(a,b,c){var d;if(!a)return 0;if(c=c?c:a,g(a.length)){for(d=0;d<a.length;d++)if(b.call(c,a[d],d,a)===!1)return 0}else for(d in a)if(a.hasOwnProperty(d)&&b.call(c,a[d],d,a)===!1)return 0;return 1}function i(a,b){return h(b,function(b,c){g(a[c],"object")&&g(b,"object")?a[c]=i(a[c],b):null!==b&&(a[c]=b)}),a}function j(a,b){var c=a,d=b||{};if(d.method){var e=c,f=window;if(h(d.method.split("."),function(a){f[a]&&(f=f[a])}),"function"==typeof f)try{c=f.apply(null,[c,d])}catch(g){c=e}}if(d.replace&&h(d.replace,function(a,b){(c==b||String(c)==String(b)||parseFloat(c)==parseFloat(b))&&(c=a)}),d.type&&"date"==d.type&&(c=d.format&&moment&&moment(a).isValid()?moment(c).format(d.format):new Date(c)),d.type&&"string"==d.type&&(c=String(c),d.format))switch(d.format){case"capitalize":c=c.replace(/[^\s]+/g,function(a){return a.replace(/^./,function(a){return a.toUpperCase()})});break;case"uppercase":c=c.toUpperCase();break;case"lowercase":c=c.toLowerCase()}return d.type&&"number"==d.type&&!isNaN(parseFloat(c))&&(c=parseFloat(c),d.format&&(-1!==d.format.indexOf(".")&&(c=function(a){var b=d.format.split("."),c=b[b.length-1].length;return a.toFixed(c)}(c)),-1!==d.format.indexOf(",")&&(c=function(a){for(var b=String(a).split(".");/(\d+)(\d{3})/.test(b[0]);)b[0]=b[0].replace(/(\d+)(\d{3})/,"$1,$2");return b.join(".")}(c)))),d.prefix&&(c=String(d.prefix)+c),d.suffix&&(c+=String(d.suffix)),c}return a.prototype.configure=function(a,e){var f,h=this;if(h.raw=h.raw||a,h.schema=h.schema||e||{},h.table=[[]],h.schema.collection&&0==g(h.schema.collection,"string"))throw new Error("schema.collection must be a string");if(h.schema.unpack&&h.schema.select)throw new Error("schema.unpack and schema.select cannot be used together");return h.schema.unpack&&(this.action="unpack",f=i({collection:"",unpack:{index:!1,value:!1,label:!1}},h.schema),f=d(f),c.call(this,f)),h.schema.select&&(this.action="select",f=i({collection:"",select:!0},h.schema),f=d(f),b.call(this,f)),this},i(a,{each:h,extend:i,is:g,flatten:f}),window.moment&&(moment.suppressDeprecationWarnings=!0),a.prototype.format=function(a){var b,c=this,d={number:{},date:{},string:{prefix:"",suffix:""}};return"select"==c.action&&(b=[],h(a,function(a){var c,e={};h(d,function(a,b){e[b]=i({},a)}),c=e[a.type]?i(e[a.type],a):a,b.push(c)}),h(c.table,function(a,d){0==d?h(a,function(a,e){b[e]&&b[e].label&&(c.table[d][e]=b[e].label)}):h(a,function(a,e){c.table[d][e]=j(c.table[d][e],b[e])})})),"unpack"==c.action&&(b={},h(a,function(a,c){var e={};h(d,function(a,b){e[b]=i({},a)}),b[c]=e[c]?i(e[c],a):a}),b.index&&h(c.table,function(a,d){0==d?b.index.label&&(c.table[d][0]=b.index.label):c.table[d][0]=j(c.table[d][0],b.index)}),b.label&&(b.index?h(c.table,function(a,d){h(a,function(a,e){0==d&&e>0&&(c.table[d][e]=j(c.table[d][e],b.label))})}):h(c.table,function(a,d){d>0&&(c.table[d][0]=j(c.table[d][0],b.label))})),b.value&&(b.index?h(c.table,function(a,d){h(a,function(a,e){d>0&&e>0&&(c.table[d][e]=j(c.table[d][e],b.value))})}):h(c.table,function(a,d){h(a,function(a,e){d>0&&(c.table[d][e]=j(c.table[d][e],b.value))})}))),c},a.prototype.sort=function(a){var b,c=this;return"unpack"==c.action&&(b=i({index:!1,value:!1},a),b.index&&!function(){var a=c.table[0],d=c.table.splice(1);d.sort(function(a,c){return"asc"==b.index?a[0]>c[0]?1:-1:"desc"==b.index?a[0]>c[0]?-1:1:!1}),c.table=[a].concat(d)}(),b.value&&c.schema.unpack.label&&c.table[0].length>2&&!function(){var a=c.table[0],d=c.table.splice(1),e=[],f=c.schema.unpack.index?0:-1;h(a,function(a,b){b>f&&e.push({label:a,values:[],total:0})}),h(d,function(a){h(a,function(a,b){b>f&&(g(a,"number")&&(e[b-1].total+=a),e[b-1].values.push(a))})}),("number"==c.schema.unpack.label.type||g(d[0][1],"number"))&&e.sort(function(a,c){return"asc"==b.value?a.total>c.total?1:-1:"desc"==b.value?a.total>c.total?-1:1:!1}),h(e,function(b,c){a[f+1+c]=e[c].label,h(d,function(a,b){a[f+1+c]=e[c].values[b]})}),c.table=[a].concat(d)}()),"select"==c.action&&(b=i({column:0,order:!1},a),!function(){var a=c.table[0],d=c.table.splice(1);d.sort(function(a,c){return"asc"==b.order?a[b.column]>c[b.column]?1:-1:"desc"==b.order?a[b.column]>c[b.column]?-1:1:!1}),c.table=[a].concat(d)}()),c},a});