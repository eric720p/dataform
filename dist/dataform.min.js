!function(a,b,c){"undefined"!=typeof module&&module.exports?module.exports=c():"function"==typeof define&&define.amd?define(c):b[a]=c()}("Dataform",this,function(){"use strict";function Dataform(a,b){this.configure(a,b)}function _select(a){var b=this,c=[],d=function(){var c,d;return""==a.collection?c=b.raw:(d=parse.apply(b,[b.raw].concat(a.collection.split(" -> "))),c=d[0]),"[object Array]"!==Object.prototype.toString.call(c)&&(c=[c]),c}();return each(a.select,function(a){c.push(a.path.split(" -> "))}),each(d,function(a,d){var e=[];each(c,function(c){var f=parse.apply(b,[a].concat(c));e.push(f[0]),0==d&&b.table[0].push(c[c.length-1])}),each(e,function(){b.table.push(e)})}),b.format(a.select),b.sort(a.sort),b}function _unpack(a){var b=this,c=a.unpack.value?a.unpack.value.path.split(" -> "):!1,d=a.unpack.label?a.unpack.label.path.split(" -> "):!1,e=a.unpack.index?a.unpack.index.path.split(" -> "):!1,f=""!==c[c.length-1]?c[c.length-1]:"Value",g=""!==d[d.length-1]?d[d.length-1]:"Label",h=""!==e[e.length-1]?e[e.length-1]:"Index",i=(a.sort.index?a.sort.index:!1,a.sort.value?a.sort.value:!1,function(){var c;return c=""==a.collection?[b.raw]:parse.apply(b,[b.raw].concat(a.collection.split(" -> "))),c[0]}());return i instanceof Array==0&&(i=[i]),each(i,function(){}),each(i,function(a,j){var k=c?parse.apply(b,[a].concat(c)):!1,l=d?parse.apply(b,[a].concat(d)):!1,m=e?parse.apply(b,[a].concat(e)):!1;m?each(m,function(){b.table.push([])}):b.table.push([]),m&&(0==j&&(b.table[0].push(h),l?each(l,function(a){b.table[0].push(a)}):b.table[0].push(f)),i.length<b.table.length-1?0==j&&each(b.table,function(a,c){c>0&&b.table[c].push(m[c-1])}):b.table[j+1].push(m[0])),!m&&l&&(0==j&&(b.table[0].push(g),b.table[0].push(f)),b.table[j+1].push(l[0])),m||l||b.table[0].push(""),k&&(i.length<b.table.length-1?0==j&&each(b.table,function(a,c){c>0&&b.table[c].push(k[c-1])}):each(k,function(a){b.table[j+1].push(a)}))}),b.format(a.unpack),b.sort(a.sort),this}function _optHash(a){return each(a.unpack,function(b,c){b&&is(b,"string")&&(a.unpack[c]={path:a.unpack[c]})}),a}function parse(){var a=[],b=function(){var c=arguments[0],d=Array.prototype.slice.call(arguments,1),e=d.pop();return 0===d.length&&(c instanceof Array?d=c:"object"==typeof c&&d.push(c)),each(d,function(f){return""==e&&"number"==typeof f?a.push(f):f[e]||0===f[e]||void 0!==f[e]?a.push(null===f[e]?"":f[e]):c[f]?c[f]instanceof Array?void each(c[f],function(a,g){var h=[c[f]].concat(c[f][g]).concat(d.slice(1)).concat(e);return b.apply(this,h)}):c[f][e]?a.push(c[f][e]):b.apply(this,[c[f]].concat(d.splice(1)).concat(e)):b.apply(this,[f].concat(d.splice(1)).concat(e))}),a.length>0?a:void 0};return b.apply(this,arguments)}function is(a,b){return a=typeof a,b?a==b:"undefined"!=a}function each(a,b,c){var d;if(!a)return 0;if(c=c?c:a,is(a.length)){for(d=0;d<a.length;d++)if(b.call(c,a[d],d,a)===!1)return 0}else for(d in a)if(a.hasOwnProperty(d)&&b.call(c,a[d],d,a)===!1)return 0;return 1}function extend(a,b){return each(b,function(b,c){is(a[c],"object")&&is(b,"object")?a[c]=extend(a[c],b):null!==b&&(a[c]=b)}),a}function _applyFormat(value,opts){var output=value,options=opts||{};if(options.method){var copy=output;try{output=eval(options.method).apply(null,[output,options])}catch(e){output=copy}}if(options.type&&"date"==options.type&&(output=options.format&&moment&&moment(value).isValid()?moment(value).format(options.format):new Date(value)),options.type&&"string"==options.type){if(options.format)switch(options.format){case"capitalize":output=output.replace(/[^\s]+/g,function(a){return a.replace(/^./,function(a){return a.toUpperCase()})});break;case"uppercase":output=output.toUpperCase();break;case"lowercase":output=output.toLowerCase()}options.replace&&each(options.replace,function(a,b){output==b&&(output=a)})}return options.type&&"number"==options.type&&options.format&&(-1!==options.format.indexOf(".")&&(output=function(a){var b=options.format.split("."),c=b[b.length-1].length;return a.toFixed(c)}(output)),-1!==options.format.indexOf(",")&&(output=function(a){for(;/(\d+)(\d{3})/.test(a.toString());)a=a.toString().replace(/(\d+)(\d{3})/,"$1,$2");return a}(output))),options.prefix&&(output=String(options.prefix)+output),options.suffix&&(output+=String(options.suffix)),output}return Dataform.prototype.configure=function(a,b){var c,d=this;if(d.raw=d.raw||a,d.schema=d.schema||b||{},d.table=[[]],d.schema.collection&&0==is(d.schema.collection,"string"))throw new Error("schema.collection must be a string");if(d.schema.unpack&&d.schema.select)throw new Error("schema.unpack and schema.select cannot be used together");return d.schema.unpack&&(this.action="unpack",c=extend({collection:"",unpack:{index:!1,value:!1,label:!1},sort:{index:!1,value:!1}},d.schema),c=_optHash(c),_unpack.call(this,c)),d.schema.select&&(this.action="select",c=extend({collection:"",select:!0},d.schema),c=_optHash(c),_select.call(this,c)),this},extend(Dataform,{each:each,extend:extend,is:is}),moment&&(moment.suppressDeprecationWarnings=!0),Dataform.prototype.format=function(a){var b,c=this,d={number:{format:"1,000.00",prefix:"",suffix:""},date:{},string:{prefix:"",suffix:""}};return"select"==c.action&&(b=[],each(a,function(a){var c,e={};each(d,function(a,b){e[b]=extend({},a)}),c=e[a.type]?extend(e[a.type],a):a,b.push(c)}),each(c.table,function(a,d){0==d?each(a,function(a,e){b[e].label&&(c.table[d][e]=b[e].label)}):each(a,function(a,e){c.table[d][e]=_applyFormat(c.table[d][e],b[e])})})),"unpack"==c.action&&(b={},each(a,function(a,c){var e={};each(d,function(a,b){e[b]=extend({},a)}),b[c]=e[c]?extend(e[c],a):a}),b.index&&each(c.table,function(a,d){0==d?b.index.label&&(c.table[d][0]=b.index.label):c.table[d][0]=_applyFormat(c.table[d][0],b.index)}),b.label&&(b.index?each(c.table,function(a,d){each(a,function(a,e){0==d&&e>0&&(c.table[d][e]=_applyFormat(c.table[d][e],b.label))})}):each(c.table,function(a,d){d>0&&(c.table[d][0]=_applyFormat(c.table[d][0],b.label))})),b.value&&(b.index?each(c.table,function(a,d){each(a,function(a,e){d>0&&e>0&&(c.table[d][e]=_applyFormat(c.table[d][e],b.value))})}):each(c.table,function(a,d){each(a,function(a,e){d>0&&(c.table[d][e]=_applyFormat(c.table[d][e],b.value))})}))),c},Dataform.prototype.sort=function(a){var b,c=this;return"unpack"==c.action&&(b=extend({index:!1,value:!1},a),b.index&&!function(){var a=c.table[0],d=c.table.splice(1);d.sort(function(a,c){return"asc"==b.index?a[0]>c[0]?1:-1:"desc"==b.index?a[0]>c[0]?-1:1:!1}),c.table=[a].concat(d)}(),b.value&&c.schema.unpack.label&&c.table[0].length>2&&!function(){var a=c.table[0],d=c.table.splice(1),e=[],f=c.schema.unpack.index?0:-1;each(a,function(a,b){b>f&&e.push({label:a,values:[],total:0})}),each(d,function(a){each(a,function(a,b){b>f&&(is(a,"number")&&(e[b-1].total+=a),e[b-1].values.push(a))})}),("number"==c.schema.unpack.label.type||is(d[0][1],"number"))&&e.sort(function(a,c){return"asc"==b.value?a.total>c.total?1:-1:"desc"==b.value?a.total>c.total?-1:1:!1}),each(e,function(b,c){a[f+1+c]=e[c].label,each(d,function(a,b){a[f+1+c]=e[c].values[b]})}),c.table=[a].concat(d)}()),"select"==c.action&&(b=extend({column:0,order:!1},a),!function(){var a=c.table[0],d=c.table.splice(1);d.sort(function(a,c){return"asc"==b.order?a[b.column]>c[b.column]?1:-1:"desc"==b.order?a[b.column]>c[b.column]?-1:1:!1}),c.table=[a].concat(d)}()),c},Dataform});