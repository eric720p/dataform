function Dataform(a,b){this.configure(a,b)}function _reduction(a){var b=this,c=[],d=function(){var c,d;return""==a.collection?c=b.raw:(d=parse.apply(b,[b.raw].concat(a.collection.split(" -> "))),c=d[0]),"[object Array]"!==Object.prototype.toString.call(c)&&(c=[c]),c}();return each(a.reduce,function(a){c.push(a.target.split(" -> "))}),each(d,function(a,d){var e=[];each(c,function(c){var f=parse.apply(b,[a].concat(c));e.push(f[0]),0==d&&b.table[0].push(c[c.length-1])}),each(e,function(){b.table.push(e)})}),b.sort(a.sort),b}function _selection(a){var b=this,c=a.select.value?a.select.value.target.split(" -> "):!1,d=a.select.label?a.select.label.target.split(" -> "):!1,e=a.select.index?a.select.index.target.split(" -> "):!1,f=(a.sort.index?a.sort.index:"asc",a.sort.index?a.sort.index:"desc",function(){var c;return c=""==a.collection?[b.raw]:parse.apply(b,[b.raw].concat(a.collection.split(" -> "))),c[0]}());return each(f,function(){b.table.push([])}),each(f,function(a,f){var g=c?parse.apply(b,[a].concat(c)):!1,h=d?parse.apply(b,[a].concat(d)):!1,i=e?parse.apply(b,[a].concat(e)):!1;i&&(0==f&&(b.table[0].push(e[e.length-1]),h?each(h,function(a){b.table[0].push(a)}):b.table[0].push(c[c.length-1])),b.table[f+1].push(i[0])),!i&&h&&(0==f&&(b.table[0].push(d[d.length-1]),b.table[0].push(c[c.length-1])),b.table[f+1].push(h[0])),i||h||b.table[0].push(""),g&&each(g,function(a){b.table[f+1].push(a)})}),b.sort(a.sort),this}function _optHash(a){return each(a.select,function(b,c){b&&is(b,"string")&&(a.select[c]={target:a.select[c]})}),a}function parse(){var a=[],b=function(){var c=arguments[0],d=Array.prototype.slice.call(arguments,1),e=d.pop();return 0===d.length&&(c instanceof Array?d=c:"object"==typeof c&&d.push(c)),each(d,function(f){return""==e&&"number"==typeof f?a.push(f):f[e]||0===f[e]||void 0!==f[e]?a.push(null===f[e]?"":f[e]):c[f]?c[f]instanceof Array?void each(c[f],function(a,g){var h=[c[f]].concat(c[f][g]).concat(d.slice(1)).concat(e);return b.apply(this,h)}):c[f][e]?a.push(c[f][e]):b.apply(this,[c[f]].concat(d.splice(1)).concat(e)):b.apply(this,[f].concat(d.splice(1)).concat(e))}),a.length>0?a:void 0};return b.apply(this,arguments)}function is(a,b){return a=typeof a,b?a==b:"undefined"!=a}function each(a,b,c){var d;if(!a)return 0;if(c=c?c:a,is(a.length)){for(d=0;d<a.length;d++)if(b.call(c,a[d],d,a)===!1)return 0}else for(d in a)if(a.hasOwnProperty(d)&&b.call(c,a[d],d,a)===!1)return 0;return 1}function extend(a,b){return each(b,function(b,c){is(a[c],"object")&&is(b,"object")?a[c]=extend(a[c],b):null!==b&&(a[c]=b)}),a}Dataform.prototype.configure=function(a,b){var c,d=this;if(d.raw=d.raw||a,d.schema=d.schema||b||{},d.table=[[]],d.schema.collection&&0==is(d.schema.collection,"string"))throw new Error("schema.collection must be a string");if(d.schema.select&&d.schema.reduce)throw new Error("schema.select and schema.reduce cannot be used together");return d.schema.select&&(this.action="select",c=extend({collection:"",select:{index:!1,value:!1,label:!1},sort:{index:"asc",value:"desc"}},d.schema),c=_optHash(c),_selection.call(this,c)),d.schema.reduce&&(this.action="reduce",c=extend({collection:"",reduce:!0},d.schema),c=_optHash(c),_reduction.call(this,c)),this},Dataform.prototype.sort=function(a){var b,c=this;return"select"==c.action&&(b=extend({index:!1,value:!1},a),b.index&&!function(){var a=c.table[0],d=c.table.splice(1);d.sort(function(a,c){return"asc"==b.index?a[0]>c[0]?1:-1:a[0]>c[0]?-1:1}),c.table=[a].concat(d)}(),b.value&&c.schema.select.label&&c.table[0].length>2&&!function(){var a=c.table[0],d=c.table.splice(1),e=[],f=c.schema.select.index?0:-1;each(a,function(a,b){b>f&&e.push({label:a,values:[],total:0})}),each(d,function(a){each(a,function(a,b){b>f&&(is(a,"number")&&(e[b-1].total+=a),e[b-1].values.push(a))})}),("number"==c.schema.select.label.type||is(d[0][1],"number"))&&e.sort(function(a,c){return"asc"==b.value?a.total>c.total?1:-1:a.total>c.total?-1:1}),each(e,function(b,c){a[f+1+c]=e[c].label,each(d,function(a,b){a[f+1+c]=e[c].values[b]})}),c.table=[a].concat(d)}()),"reduce"==c.action&&(b=extend({0:"asc"},a),console.log(b)),c},Dataform.prototype.average=function(){return[5]},Dataform.prototype.count=function(){return[10]},Dataform.prototype.maximum=function(){return[9]},Dataform.prototype.median=function(){return[4.3]},Dataform.prototype.minimum=function(){return[0]},Dataform.prototype.mode=function(){return[3]},Dataform.prototype.sum=function(){return[23]};