function Dataform(a,b){this.configure(a,b)}function _optHash(a){return each(a.select,function(b,c){b&&is(b,"string")&&(a.select[c]={target:a.select[c]})}),a}function _reduction(a){return console.log("Reduction",a),this}function _selection(a){var b=this,c=[],d=a.select.value?a.select.value.target.split(" -> "):!1,e=a.select.label?a.select.label.target.split(" -> "):!1,f=a.select.index?a.select.index.target.split(" -> "):!1,g=(a.sort.index?a.sort.index:"asc",a.sort.index?a.sort.index:"desc",function(){var c;return c=""==a.collection?[b.raw]:parse.apply(b,[b.raw].concat(a.collection.split(" -> "))),c[0]}());return g instanceof Array&&g.sort(function(c,d){var g,h,i,j;return f?(i=f,j=a.sort.index):e&&(i=e,j=a.sort.label),g=parse.apply(b,[c].concat(i)),h=parse.apply(b,[d].concat(i)),"asc"==j?g>h?1:-1:g>h?-1:1}),b.table.push([]),each(g,function(){b.table.push([])}),each(g,function(a,g){var h=d?parse.apply(b,[a].concat(d)):!1,i=e?parse.apply(b,[a].concat(e)):!1,j=f?parse.apply(b,[a].concat(f)):!1;j&&(0==g&&(b.table[0].push(f[f.length-1]),i?each(i,function(a){b.table[0].push(a)}):b.table[0].push(d[d.length-1])),b.table[g+1].push(j[0])),i&&each(i,function(){}),!j&&i&&(0==g&&(b.table[0].push(e[e.length-1]),b.table[0].push(d[d.length-1])),b.table[g+1].push(i[0])),j||i||b.table[0].push(""),h&&each(h,function(a){console.log(h.length,c.length),b.table[g+1].push(a)})}),console.log(c),this}function parse(){var a=[],b=function(){var c=arguments[0],d=Array.prototype.slice.call(arguments,1),e=d.pop();return 0===d.length&&(c instanceof Array?d=c:"object"==typeof c&&d.push(c)),each(d,function(f){return""==e&&"number"==typeof f?a.push(f):f[e]||0===f[e]||void 0!==f[e]?a.push(null===f[e]?"":f[e]):c[f]?c[f]instanceof Array?void each(c[f],function(a,g){var h=[c[f]].concat(c[f][g]).concat(d.slice(1)).concat(e);return b.apply(this,h)}):c[f][e]?a.push(c[f][e]):b.apply(this,[c[f]].concat(d.splice(1)).concat(e)):b.apply(this,[f].concat(d.splice(1)).concat(e))}),a.length>0?a:void 0};return b.apply(this,arguments)}function is(a,b){return a=typeof a,b?a==b:"undefined"!=a}function each(a,b,c){var d;if(!a)return 0;if(c=c?c:a,is(a.length)){for(d=0;d<a.length;d++)if(b.call(c,a[d],d,a)===!1)return 0}else for(d in a)if(a.hasOwnProperty(d)&&b.call(c,a[d],d,a)===!1)return 0;return 1}function extend(a,b){return each(b,function(b,c){is(a[c],"object")&&is(b,"object")?a[c]=extend(a[c],b):null!==b&&(a[c]=b)}),a}Dataform.prototype.configure=function(a,b){var c,d=this;if(d.raw=d.raw||a,d.schema=d.schema||b||{},d.table=[],d.schema.collection&&0==is(d.schema.collection,"string"))throw new Error("schema.collection must be a string");if(d.schema.select&&d.schema.reduce)throw new Error("schema.select and schema.reduce cannot be used together");return d.schema.select&&(c=extend({collection:"",select:{index:!1,value:!1,label:!1},sort:{index:"asc",value:"desc"}},d.schema),c=_optHash(c),_selection.call(this,c)),d.schema.reduce&&(c=extend({collection:"",reduce:!0},d.schema),c=_optHash(c),_reduction.call(this,c)),this},Dataform.prototype.build=function(a,b){var c=this,d=b;c.raw=a,c.schema=b;{var e=extend({root:"",each:{index:!1,values:!1,labels:!1}},c.schema);c.root=function(){var a;return a=""==e.root?[[c.raw]]:parse.apply(c,[c.raw].concat(e.root.split(" -> "))),a[0]}()}return c.map=d,c.table=[],c.series=[],c.cols=function(){var a,b,d={fixed:[]};return b=c.map.each.value.split(" -> "),a=c.map.each.index?c.map.each.index.split(" -> "):c.map.each.value.split(" -> "),d.fixed.push(a[a.length-1]),c.map.each.label?d.cells=c.map.each.label.split(" -> "):d.fixed.push(b[b.length-1]),d}(),c.rows={index:c.map.each.index?c.map.each.index.split(" -> "):["result"],cells:c.map.each.value?c.map.each.value.split(" -> "):[]},c.order=function(){var a={};return c.map.sort&&(a.rows=c.map.sort.index||"asc",a.cols=c.map.sort.label||"desc"),a}(),c.order.rows.length>0&&c.root instanceof Array&&c.root.sort(function(a,b){var d=parse.apply(c,[a].concat(c.rows.index)),e=parse.apply(c,[b].concat(c.rows.index));return"asc"==c.order.rows?d>e?1:e>d?-1:0:d>e?-1:e>d?1:0}),function(){c.cols.fixed&&""==c.cols.fixed[c.cols.fixed.length-1]?(c.cols.label=c.cols.fixed[c.cols.fixed.length-1],fixed=c.cols.fixed,fixed.splice(fixed.length-1,1)):(c.cols.label=fixed=c.cols.fixed[0],fixed=c.cols.fixed);var a=c.cols.cells?parse.apply(c,[c.root[0]].concat(c.cols.cells)):[],b=fixed.concat(a);b.length>1&&b.splice(0,1),each(b,function(a){c.series.push({key:a,values:[]})})}(),c.root instanceof Array||"object"==typeof c.root?each(c.root,function(a){var b=parse.apply(c,[a].concat(c.rows.index)),d=parse.apply(c,[a].concat(c.rows.cells));b.length>1?each(b,function(a,b){var e={};e[c.cols.label]=a,e.value=d[b],c.series[0].values.push(e)}):each(d,function(a,d){var e={};e[c.cols.label]=b[0],e.value=a,c.series[d].values.push(e)})}):!function(){var a={};a[c.cols.label]="result",a.value=c.root,c.series[0].values.push(a)}(),c.order.cols.length>0&&(c.series=c.series.sort(function(a,b){var d=0,e=0;return each(a.values,function(a){d+=a.value}),each(b.values,function(a){e+=a.value}),"asc"==c.order.cols?d-e:e-d})),c.table=[],c.table.push([c.cols.label]),each(c.series[0].values,function(a){c.table.push([a[c.cols.label]])}),each(c.series,function(a){c.table[0].push(a.key),each(a.values,function(a,b){c.table[b+1].push(a.value)})}),this},Dataform.prototype.average=function(){return[5]},Dataform.prototype.count=function(){return[10]},Dataform.prototype.maximum=function(){return[9]},Dataform.prototype.median=function(){return[4.3]},Dataform.prototype.minimum=function(){return[0]},Dataform.prototype.mode=function(){return[3]},Dataform.prototype.sum=function(){return[23]};