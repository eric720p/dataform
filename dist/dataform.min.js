function flatten(a,b){this.build(a,b)}function parse(){var a=[],b=function(){var c=arguments[0],d=Array.prototype.slice.call(arguments,1),e=d.pop();return 0==d.length&&(c instanceof Array?d=c:"object"==typeof c&&d.push(c)),_each(d,function(f){return f[e]||0==f[e]||void 0!==f[e]?a.push(null==f[e]?"":f[e]):c[f]?c[f]instanceof Array?void _each(c[f],function(a,g){var h=[c[f]].concat(c[f][g]).concat(d.slice(1)).concat(e);return b.apply(this,h)}):c[f][e]?a.push(c[f][e]):b.apply(this,[c[f]].concat(d.splice(1)).concat(e)):b.apply(this,[f].concat(d.splice(1)).concat(e))}),a.length>0?a:void 0};return b.apply(this,arguments)}var _each=function(a,b,c){if(null==a)return a;if(Array.prototype.forEach&&a.forEach===Array.prototype.forEach)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(b.call(c,a[d],d,a)===breaker)return}else for(var f=_.keys(a),d=0,e=f.length;e>d;d++)if(b.call(c,a[f[d]],f[d],a)===breaker)return;return a};flatten.prototype.build=function(a,b){var c=this;if(c.cols={label:b.cols.label?b.cols.label.split(" -> "):!1,cells:b.cols.cells?b.cols.cells.split(" -> "):!1,fixed:b.cols.fixed?b.cols.fixed:!1},c.rows={index:b.rows.index.split(" -> "),cells:b.rows.cells.split(" -> ")},c.order={rows:b.order&&b.order.rows?b.order.rows.split(":"):!1,cols:b.order&&b.order.cols?b.order.cols.split(":"):!1},c.table=[],c.series=[],c.raw=a,c.order.rows.length>0&&a.sort(function(a,b){var d=parse.apply(c,[a].concat(c.rows.index)),e=parse.apply(c,[b].concat(c.rows.index));return"asc"==c.order.rows[1]?d>e?1:e>d?-1:0:d>e?-1:e>d?1:0}),function(){c.cols.label=c.cols.fixed?c.cols.fixed[0]:"series";var b=c.cols.fixed?c.cols.fixed:[],d=c.cols.cells?parse.apply(c,[a[0]].concat(c.cols.cells)):[],e=b.concat(d);e.splice(0,1),_each(e,function(a){c.series.push({key:a,values:[]})})}(),_each(a,function(a){var b=parse.apply(c,[a].concat(c.rows.index)),d=parse.apply(c,[a].concat(c.rows.cells));_each(d,function(a,d){var e={};e[c.cols.label]=b[0],e.value=a,c.series[d].values.push(e)})}),c.order.cols.length>0&&(c.series=c.series.sort(function(a,b){var d=0,e=0;return _each(a.values,function(a){d+=a.value}),_each(b.values,function(a){e+=a.value}),"asc"==c.order.cols[1]?d-e:e-d})),c.table=[],c.table.push([c.cols.label]),_each(c.series[0].values,function(a){c.table.push([a[c.cols.label]])}),_each(c.series,function(a){c.table[0].push(a.key),_each(a.values,function(a,b){c.table[b+1].push(a.value)})}),b.cols.transform)for(var d in b.cols.transform)"all"==d?_each(c.table[0],function(a,e){e>0&&(c.table[0][e]=b.cols.transform[d](c.table[0][e],e))}):(d=parseInt(d),c.table[0].length>d&&(c.table[0][d]=b.cols.transform[d](c.table[0][d])));return b.rows.transform&&_each(c.table,function(a,d){if(d>0)for(var e in b.rows.transform)c.table[d][e]=b.rows.transform[e](c.table[d][e],d)}),this},flatten.prototype.render=function(a){return"csv"==a&&console.log(this.table.join("\n")),this};